name: Centralized Release (Batch Update CHANGELOG)

on:
  workflow_dispatch:
    inputs:
      repositories:
        description: 'ä»“åº“å’Œç‰ˆæœ¬é…ç½® (æ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼: repo=version)'
        required: true
        type: string
        default: |
          # ç¤ºä¾‹:
          # wujihandpy=1.5.0
          # wujihandros2=2.0.0
      release_date:
        description: 'å‘å¸ƒæ—¥æœŸ (YYYY-MM-DDï¼Œç•™ç©ºåˆ™ä½¿ç”¨å½“å¤©)'
        required: false
        type: string
        default: ''
      dry_run:
        description: 'Dry run (ä»…æµ‹è¯•ï¼Œä¸åˆ›å»º PR)'
        required: false
        type: boolean
        default: false

jobs:
  parse-input:
    name: Parse Repository Configuration
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.parse.outputs.matrix }}
    steps:
      - name: Checkout .github repository
        uses: actions/checkout@v4

      - name: Parse repositories input
        id: parse
        run: |
          echo "è§£æä»“åº“é…ç½®..."
          cat <<'EOF' | python3 scripts/parse-repos.py > repos.json
          ${{ inputs.repositories }}
          EOF

          # è¯»å–å¹¶è¾“å‡º
          matrix=$(cat repos.json | jq -c '{include: .}')
          echo "matrix=$matrix" >> $GITHUB_OUTPUT

          echo "âœ… è§£ææˆåŠŸï¼Œå°†å¤„ç†ä»¥ä¸‹ä»“åº“:"
          cat repos.json | jq -r '.[] | "  - \(.repo) v\(.version)"'

  update-changelog:
    name: Update CHANGELOG - ${{ matrix.repo }} v${{ matrix.version }}
    needs: parse-input
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 3
      fail-fast: false
      matrix: ${{ fromJson(needs.parse-input.outputs.matrix) }}

    steps:
      - name: Checkout .github repository
        uses: actions/checkout@v4
        with:
          path: .github-repo

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.AUTOMATION_APP_ID }}
          private-key: ${{ secrets.AUTOMATION_APP_PRIVATE_KEY }}
          repositories: ${{ matrix.repo }}

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: wuji-technology/${{ matrix.repo }}
          token: ${{ steps.app-token.outputs.token }}
          path: target-repo

      - name: Validate CHANGELOG exists
        working-directory: target-repo
        run: |
          if [ ! -f "${{ matrix.changelog_path }}" ]; then
            echo "âŒ é”™è¯¯: ${{ matrix.changelog_path }} ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… ${{ matrix.changelog_path }} å­˜åœ¨"

      - name: Update CHANGELOG.md
        working-directory: target-repo
        env:
          RELEASE_DATE: ${{ inputs.release_date }}
          CHANGELOG_PATH: ${{ matrix.changelog_path }}
        run: |
          date_arg=""
          if [ -n "$RELEASE_DATE" ]; then
            date_arg="--date $RELEASE_DATE"
            echo "ğŸ“… ä½¿ç”¨æŒ‡å®šå‘å¸ƒæ—¥æœŸ: $RELEASE_DATE"
          else
            echo "ğŸ“… ä½¿ç”¨å½“å¤©æ—¥æœŸ"
          fi

          python3 ../.github-repo/scripts/update-changelog.py \
            --file "$CHANGELOG_PATH" \
            --version ${{ matrix.version }} \
            $date_arg

      - name: Create release branch
        if: ${{ !inputs.dry_run }}
        working-directory: target-repo
        env:
          VERSION: ${{ matrix.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          branch_name="release/v${VERSION}"
          git checkout -b "$branch_name"
          git add "${{ matrix.changelog_path }}"
          git commit -m "release: v${VERSION}

          Update CHANGELOG.md for v${VERSION} release"

          git push origin "$branch_name"
          echo "âœ… å·²æ¨é€åˆ†æ”¯: $branch_name"

      - name: Create Pull Request
        if: ${{ !inputs.dry_run }}
        working-directory: target-repo
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          VERSION: ${{ matrix.version }}
          RELEASE_DATE: ${{ inputs.release_date }}
        run: |
          # ç¡®ä¿ auto-release label å­˜åœ¨
          gh label create "auto-release" --description "Trigger auto-release on PR merge" --color "0E8A16" 2>/dev/null || true

          # æ˜¾ç¤ºå‘å¸ƒæ—¥æœŸä¿¡æ¯
          date_info=""
          if [ -n "$RELEASE_DATE" ]; then
            date_info="- **è®¡åˆ’å‘å¸ƒæ—¥æœŸ**: ${RELEASE_DATE}"
          fi

          pr_body="## Release v${VERSION}

          æ­¤ PR ç”±é›†ä¸­å¼ Release è‡ªåŠ¨åŒ–æµç¨‹åˆ›å»ºã€‚

          ### å˜æ›´å†…å®¹
          - æ›´æ–° CHANGELOG.mdï¼Œå°† Unreleased æ›¿æ¢ä¸º v${VERSION}
          ${date_info}

          ### åç»­æ­¥éª¤
          1. âœ… å®¡æ ¸ CHANGELOG å†…å®¹
          2. âœ… åœ¨å‘å¸ƒæ—¥æœŸåˆå¹¶æ­¤ PR
          3. ğŸ¤– è‡ªåŠ¨è§¦å‘: æ‰“ tagã€åˆ›å»º releaseã€å‘é€é£ä¹¦é€šçŸ¥

          ---

          ğŸ¤– Created by [Centralized Release Automation](https://github.com/wuji-technology/.github)"

          pr_url=$(gh pr create \
            --title "release: v${VERSION}" \
            --body "$pr_body" \
            --label "auto-release" \
            --base main \
            --head "release/v${VERSION}")

          echo "âœ… PR åˆ›å»ºæˆåŠŸ: $pr_url"

      - name: Dry run summary
        if: ${{ inputs.dry_run }}
        run: |
          echo "ğŸ” Dry run æ¨¡å¼ï¼Œä¸åˆ›å»º PR"
          echo "âœ… CHANGELOG æ›´æ–°æˆåŠŸ"
          echo ""
          echo "å¦‚éœ€å®é™…åˆ›å»º PRï¼Œè¯·å–æ¶ˆå‹¾é€‰ dry_run é€‰é¡¹"

  notify-feishu:
    name: Notify Feishu
    needs: [parse-input, update-changelog]
    if: always() && needs.parse-input.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Build notification content
        id: build-content
        env:
          REPOS_INPUT: ${{ inputs.repositories }}
          RELEASE_DATE: ${{ inputs.release_date }}
          DRY_RUN: ${{ inputs.dry_run }}
          JOB_STATUS: ${{ needs.update-changelog.result }}
        run: |
          # è®¾ç½®çŠ¶æ€
          if [ "$JOB_STATUS" = "success" ]; then
            echo "status_emoji=âœ…" >> $GITHUB_OUTPUT
            echo "status_text=æˆåŠŸ" >> $GITHUB_OUTPUT
            echo "card_color=green" >> $GITHUB_OUTPUT
          else
            echo "status_emoji=âŒ" >> $GITHUB_OUTPUT
            echo "status_text=å¤±è´¥" >> $GITHUB_OUTPUT
            echo "card_color=red" >> $GITHUB_OUTPUT
          fi

          # dry run æ ‡è®°
          if [ "$DRY_RUN" = "true" ]; then
            echo "dry_run_tag= ğŸ§ª DRY RUN" >> $GITHUB_OUTPUT
          else
            echo "dry_run_tag=" >> $GITHUB_OUTPUT
          fi

          # è§£æä»“åº“åˆ—è¡¨å¹¶ç”Ÿæˆå¸¦é“¾æ¥çš„ markdown
          REPO_MD=""
          while IFS= read -r line; do
            # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
            line=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            [[ -z "$line" || "$line" == \#* ]] && continue

            REPO=$(echo "$line" | cut -d'=' -f1)
            VERSION=$(echo "$line" | cut -d'=' -f2)
            REPO_MD="${REPO_MD}â€¢ [${REPO}](https://github.com/wuji-technology/${REPO}/pulls) â†’ v${VERSION}\\n"
          done <<< "$REPOS_INPUT"

          # ä¿å­˜ä»“åº“åˆ—è¡¨ï¼ˆä½¿ç”¨ delimiter æ–¹å¼å¤„ç†å¤šè¡Œï¼‰
          EOF_MARKER=$(dd if=/dev/urandom bs=15 count=1 2>/dev/null | base64)
          echo "repo_md<<${EOF_MARKER}" >> $GITHUB_OUTPUT
          echo -e "$REPO_MD" >> $GITHUB_OUTPUT
          echo "${EOF_MARKER}" >> $GITHUB_OUTPUT

          # å‘å¸ƒæ—¥æœŸ
          if [ -n "$RELEASE_DATE" ]; then
            echo "release_date=$RELEASE_DATE" >> $GITHUB_OUTPUT
          else
            echo "release_date=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          fi

      - name: Send Feishu notification
        env:
          WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
        run: |
          # è½¬ä¹‰ repo_md ä¸­çš„æ¢è¡Œç¬¦ç”¨äº JSON
          REPO_MD_ESCAPED=$(cat <<'CONTENT'
          ${{ steps.build-content.outputs.repo_md }}
          CONTENT
          )
          REPO_MD_ESCAPED=$(echo "$REPO_MD_ESCAPED" | sed ':a;N;$!ba;s/\n/\\n/g' | sed 's/"/\\"/g')

          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "interactive",
              "card": {
                "header": {
                  "title": {
                    "content": "${{ steps.build-content.outputs.status_emoji }} Release è‡ªåŠ¨åŒ–${{ steps.build-content.outputs.status_text }}${{ steps.build-content.outputs.dry_run_tag }}",
                    "tag": "plain_text"
                  },
                  "template": "${{ steps.build-content.outputs.card_color }}"
                },
                "elements": [
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "**å‘å¸ƒæ—¥æœŸ**: ${{ steps.build-content.outputs.release_date }}\n**è§¦å‘è€…**: ${{ github.actor }}"
                    }
                  },
                  {
                    "tag": "hr"
                  },
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "**æ¶‰åŠä»“åº“**:\\n'"$REPO_MD_ESCAPED"'"
                    }
                  },
                  {
                    "tag": "action",
                    "actions": [
                      {
                        "tag": "button",
                        "text": {
                          "tag": "plain_text",
                          "content": "æŸ¥çœ‹è¿è¡Œè¯¦æƒ…"
                        },
                        "type": "primary",
                        "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                      }
                    ]
                  },
                  {
                    "tag": "note",
                    "elements": [
                      {
                        "tag": "plain_text",
                        "content": "ğŸ¤– Centralized Release Automation"
                      }
                    ]
                  }
                ]
              }
            }'
