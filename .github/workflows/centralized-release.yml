name: Centralized Release (Batch Update CHANGELOG)

on:
  workflow_dispatch:
    inputs:
      repositories:
        description: 'ä»“åº“å’Œç‰ˆæœ¬é…ç½® (æ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼: repo=version)'
        required: true
        type: string
        default: |
          # ç¤ºä¾‹:
          # wujihandpy=1.5.0
          # wujihandros2=2.0.0
      release_date:
        description: 'å‘å¸ƒæ—¥æœŸ (YYYY-MM-DDï¼Œç•™ç©ºåˆ™ä½¿ç”¨å½“å¤©)'
        required: false
        type: string
        default: ''
      dry_run:
        description: 'Dry run (ä»…æµ‹è¯•ï¼Œä¸åˆ›å»º PR)'
        required: false
        type: boolean
        default: false

jobs:
  parse-input:
    name: Parse Repository Configuration
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.parse.outputs.matrix }}
    steps:
      - name: Checkout .github repository
        uses: actions/checkout@v4

      - name: Parse repositories input
        id: parse
        run: |
          echo "è§£æä»“åº“é…ç½®..."
          cat <<'EOF' | python3 scripts/parse-repos.py > repos.json
          ${{ inputs.repositories }}
          EOF

          # è¯»å–å¹¶è¾“å‡º
          matrix=$(cat repos.json | jq -c '{include: .}')
          echo "matrix=$matrix" >> $GITHUB_OUTPUT

          echo "âœ… è§£ææˆåŠŸï¼Œå°†å¤„ç†ä»¥ä¸‹ä»“åº“:"
          cat repos.json | jq -r '.[] | "  - \(.repo) v\(.version)"'

  update-changelog:
    name: Update CHANGELOG - ${{ matrix.repo }} v${{ matrix.version }}
    needs: parse-input
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 3
      fail-fast: false
      matrix: ${{ fromJson(needs.parse-input.outputs.matrix) }}

    steps:
      - name: Checkout .github repository
        uses: actions/checkout@v4
        with:
          path: .github-repo

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.AUTOMATION_APP_ID }}
          private-key: ${{ secrets.AUTOMATION_APP_PRIVATE_KEY }}
          repositories: ${{ matrix.repo }}

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: wuji-technology/${{ matrix.repo }}
          token: ${{ steps.app-token.outputs.token }}
          path: target-repo

      - name: Validate CHANGELOG exists
        working-directory: target-repo
        run: |
          if [ ! -f "${{ matrix.changelog_path }}" ]; then
            echo "âŒ é”™è¯¯: ${{ matrix.changelog_path }} ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… ${{ matrix.changelog_path }} å­˜åœ¨"

      - name: Update CHANGELOG.md
        working-directory: target-repo
        env:
          RELEASE_DATE: ${{ inputs.release_date }}
          CHANGELOG_PATH: ${{ matrix.changelog_path }}
        run: |
          date_arg=""
          if [ -n "$RELEASE_DATE" ]; then
            date_arg="--date $RELEASE_DATE"
            echo "ğŸ“… ä½¿ç”¨æŒ‡å®šå‘å¸ƒæ—¥æœŸ: $RELEASE_DATE"
          else
            echo "ğŸ“… ä½¿ç”¨å½“å¤©æ—¥æœŸ"
          fi

          python3 ../.github-repo/scripts/update-changelog.py \
            --file "$CHANGELOG_PATH" \
            --version ${{ matrix.version }} \
            $date_arg

      - name: Update public CHANGELOG.md
        if: ${{ matrix.public_changelog_path != '' }}
        working-directory: target-repo
        env:
          RELEASE_DATE: ${{ inputs.release_date }}
          PUBLIC_CHANGELOG_PATH: ${{ matrix.public_changelog_path }}
        run: |
          if [ ! -f "$PUBLIC_CHANGELOG_PATH" ]; then
            echo "âŒ é”™è¯¯: $PUBLIC_CHANGELOG_PATH ä¸å­˜åœ¨"
            exit 1
          fi

          date_arg=""
          if [ -n "$RELEASE_DATE" ]; then
            date_arg="--date $RELEASE_DATE"
          fi

          python3 ../.github-repo/scripts/update-changelog.py \
            --file "$PUBLIC_CHANGELOG_PATH" \
            --version ${{ matrix.version }} \
            $date_arg

      - name: Create release branch
        if: ${{ !inputs.dry_run }}
        working-directory: target-repo
        env:
          VERSION: ${{ matrix.version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          branch_name="release/v${VERSION}"
          git checkout -b "$branch_name"
          git add "${{ matrix.changelog_path }}"
          if [ -n "${{ matrix.public_changelog_path }}" ]; then
            git add "${{ matrix.public_changelog_path }}"
          fi
          git commit -m "release: v${VERSION}

          Update CHANGELOG.md for v${VERSION} release"

          git push origin "$branch_name"
          echo "âœ… å·²æ¨é€åˆ†æ”¯: $branch_name"

      - name: Create Pull Request
        if: ${{ !inputs.dry_run }}
        working-directory: target-repo
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          VERSION: ${{ matrix.version }}
          RELEASE_DATE: ${{ inputs.release_date }}
        run: |
          # ç¡®ä¿ auto-release label å­˜åœ¨
          gh label create "auto-release" --description "Trigger auto-release on PR merge" --color "0E8A16" 2>/dev/null || true

          # æ˜¾ç¤ºå‘å¸ƒæ—¥æœŸä¿¡æ¯
          date_info=""
          if [ -n "$RELEASE_DATE" ]; then
            date_info="- **è®¡åˆ’å‘å¸ƒæ—¥æœŸ**: ${RELEASE_DATE}"
          fi

          pr_body="## Release v${VERSION}

          æ­¤ PR ç”±é›†ä¸­å¼ Release è‡ªåŠ¨åŒ–æµç¨‹åˆ›å»ºã€‚

          ### å˜æ›´å†…å®¹
          - æ›´æ–° CHANGELOG.mdï¼Œå°† Unreleased æ›¿æ¢ä¸º v${VERSION}
          ${date_info}

          ### åç»­æ­¥éª¤
          1. âœ… å®¡æ ¸ CHANGELOG å†…å®¹
          2. âœ… åœ¨å‘å¸ƒæ—¥æœŸåˆå¹¶æ­¤ PR
          3. ğŸ¤– è‡ªåŠ¨è§¦å‘: æ‰“ tagã€åˆ›å»º releaseã€å‘é€é£ä¹¦é€šçŸ¥

          ---

          ğŸ¤– Created by [Centralized Release Automation](https://github.com/wuji-technology/.github)"

          pr_url=$(gh pr create \
            --title "release: v${VERSION}" \
            --body "$pr_body" \
            --label "auto-release" \
            --base main \
            --head "release/v${VERSION}")

          echo "âœ… PR åˆ›å»ºæˆåŠŸ: $pr_url"

      - name: Dry run summary
        if: ${{ inputs.dry_run }}
        run: |
          echo "ğŸ” Dry run æ¨¡å¼ï¼Œä¸åˆ›å»º PR"
          echo "âœ… CHANGELOG æ›´æ–°æˆåŠŸ"
          echo ""
          echo "å¦‚éœ€å®é™…åˆ›å»º PRï¼Œè¯·å–æ¶ˆå‹¾é€‰ dry_run é€‰é¡¹"

  notify-feishu:
    name: Notify Feishu
    needs: [parse-input, update-changelog]
    if: always() && needs.parse-input.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Send Feishu notification
        env:
          WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          REPOS_INPUT: ${{ inputs.repositories }}
          RELEASE_DATE: ${{ inputs.release_date }}
          DRY_RUN: ${{ inputs.dry_run }}
          JOB_STATUS: ${{ needs.update-changelog.result }}
          ACTOR: ${{ github.actor }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          # è®¾ç½®çŠ¶æ€
          if [ "$JOB_STATUS" = "success" ]; then
            STATUS_EMOJI="âœ…"
            STATUS_TEXT="æˆåŠŸ"
            CARD_COLOR="green"
          else
            STATUS_EMOJI="âŒ"
            STATUS_TEXT="å¤±è´¥"
            CARD_COLOR="red"
          fi

          # dry run æ ‡è®°
          DRY_RUN_TAG=""
          if [ "$DRY_RUN" = "true" ]; then
            DRY_RUN_TAG=" ğŸ§ª DRY RUN"
          fi

          # å‘å¸ƒæ—¥æœŸ
          if [ -n "$RELEASE_DATE" ]; then
            DISPLAY_DATE="$RELEASE_DATE"
          else
            DISPLAY_DATE="$(date +%Y-%m-%d)"
          fi

          # è§£æä»“åº“åˆ—è¡¨å¹¶ç”Ÿæˆå¸¦é“¾æ¥çš„ markdown
          REPO_LINES=""
          while IFS= read -r line; do
            # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
            line=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            [[ -z "$line" || "$line" == \#* ]] && continue

            # å¤„ç†å¯èƒ½çš„ :changelog_path åç¼€
            REPO_VERSION=$(echo "$line" | cut -d':' -f1)
            REPO=$(echo "$REPO_VERSION" | cut -d'=' -f1)
            VERSION=$(echo "$REPO_VERSION" | cut -d'=' -f2)

            if [ -n "$REPO_LINES" ]; then
              REPO_LINES="${REPO_LINES}"$'\n'
            fi
            REPO_LINES="${REPO_LINES}â€¢ [${REPO}](https://github.com/wuji-technology/${REPO}/pulls) â†’ v${VERSION}"
          done <<< "$REPOS_INPUT"

          # ä½¿ç”¨ jq æ„å»º JSONï¼ˆè‡ªåŠ¨å¤„ç†è½¬ä¹‰ï¼‰
          TITLE="${STATUS_EMOJI} Release è‡ªåŠ¨åŒ–${STATUS_TEXT}${DRY_RUN_TAG}"
          INFO_CONTENT="**å‘å¸ƒæ—¥æœŸ**: ${DISPLAY_DATE}"$'\n'"**è§¦å‘è€…**: ${ACTOR}"
          REPO_CONTENT="**æ¶‰åŠä»“åº“**:"$'\n'"${REPO_LINES}"

          JSON_PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --arg color "$CARD_COLOR" \
            --arg info "$INFO_CONTENT" \
            --arg repos "$REPO_CONTENT" \
            --arg url "$RUN_URL" \
            '{
              msg_type: "interactive",
              card: {
                header: {
                  title: { content: $title, tag: "plain_text" },
                  template: $color
                },
                elements: [
                  { tag: "div", text: { tag: "lark_md", content: $info } },
                  { tag: "hr" },
                  { tag: "div", text: { tag: "lark_md", content: $repos } },
                  { tag: "action", actions: [{ tag: "button", text: { tag: "plain_text", content: "æŸ¥çœ‹è¿è¡Œè¯¦æƒ…" }, type: "primary", url: $url }] },
                  { tag: "note", elements: [{ tag: "plain_text", content: "ğŸ¤– Centralized Release Automation" }] }
                ]
              }
            }')

          curl -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD"
