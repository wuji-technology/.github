name: Collect Changelogs & Generate Release Notes

on:
  workflow_dispatch:
    inputs:
      repositories:
        description: 'ä»“åº“å’Œç‰ˆæœ¬é…ç½® (æ¯è¡Œä¸€ä¸ªï¼Œæ ¼å¼: repo=version)'
        required: true
        type: string
        default: |
          # ç¤ºä¾‹:
          # wujihandpy=1.5.1
          # wujihand-hmi-dev=1.5.1
          # firmware=1.2.1
      release_date:
        description: 'å‘å¸ƒæ—¥æœŸ (YYYY-MM-DDï¼Œç•™ç©ºåˆ™ä½¿ç”¨å½“å¤©)'
        required: false
        type: string
        default: ''
      dry_run:
        description: 'Dry run (ä»…æµ‹è¯•ï¼Œä¸åˆ›å»º PR)'
        required: false
        type: boolean
        default: false

  workflow_call:
    inputs:
      repositories:
        description: 'ä»“åº“å’Œç‰ˆæœ¬é…ç½®'
        required: true
        type: string
      release_date:
        description: 'å‘å¸ƒæ—¥æœŸ'
        required: false
        type: string
        default: ''
      dry_run:
        description: 'Dry run'
        required: false
        type: boolean
        default: false

jobs:
  collect-and-generate:
    name: Collect Changelogs & Generate PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout .github repository
        uses: actions/checkout@v4

      - name: Generate GitHub App token (source repos)
        id: app-token-source
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.AUTOMATION_APP_ID }}
          private-key: ${{ secrets.AUTOMATION_APP_PRIVATE_KEY }}
          owner: wuji-technology

      - name: Generate GitHub App token (docs repo)
        id: app-token-docs
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.AUTOMATION_APP_ID }}
          private-key: ${{ secrets.AUTOMATION_APP_PRIVATE_KEY }}
          repositories: wuji-docs-center

      - name: Parse repositories input
        run: |
          cat <<'EOF' | python3 scripts/parse-repos.py > repos.json
          ${{ inputs.repositories }}
          EOF
          echo "âœ… è§£ææˆåŠŸ:"
          cat repos.json | jq -r '.[] | "  - \(.repo) v\(.version)"'

      - name: Fetch changelogs
        env:
          GITHUB_TOKEN: ${{ steps.app-token-source.outputs.token }}
          RELEASE_DATE: ${{ inputs.release_date }}
        run: |
          cat repos.json | python3 scripts/fetch-changelogs.py > changelogs.json
          echo "âœ… CHANGELOG æŠ“å–å®Œæˆ"
          echo ""
          echo "=== æŠ“å–ç»“æœ ==="
          cat changelogs.json | jq -r '.[] | "\(.repo) v\(.version): \(if .changelog then "âœ… å·²è·å–" else "âš ï¸ æœªè·å–" end)"'

      - name: Dry run - preview output
        if: ${{ inputs.dry_run }}
        env:
          RELEASE_DATE: ${{ inputs.release_date }}
        run: |
          echo "ğŸ” Dry run æ¨¡å¼ï¼Œé¢„è§ˆç”Ÿæˆç»“æœ:"
          echo ""
          date_arg=""
          if [ -n "$RELEASE_DATE" ]; then
            date_arg="--release-date $RELEASE_DATE"
          fi
          cat changelogs.json | python3 scripts/generate-release-template.py \
            --output-dir /tmp \
            --dry-run \
            $date_arg

      - name: Checkout docs repository
        if: ${{ !inputs.dry_run }}
        uses: actions/checkout@v4
        with:
          repository: wuji-technology/wuji-docs-center
          token: ${{ steps.app-token-docs.outputs.token }}
          path: docs-repo

      - name: Generate release notes
        if: ${{ !inputs.dry_run }}
        env:
          RELEASE_DATE: ${{ inputs.release_date }}
        run: |
          if [ -n "$RELEASE_DATE" ]; then
            display_date="$RELEASE_DATE"
            date_arg="--release-date $RELEASE_DATE"
          else
            display_date="$(date +%Y-%m-%d)"
            date_arg=""
          fi

          echo "branch_name=chore/update-release-notes-${display_date}" >> $GITHUB_ENV
          echo "display_date=$display_date" >> $GITHUB_ENV

          cat changelogs.json | python3 scripts/generate-release-template.py \
            --output-dir docs-repo \
            $date_arg

      - name: Create branch and push
        if: ${{ !inputs.dry_run }}
        working-directory: docs-repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "${{ env.branch_name }}"
          git add content/docs/zh/wuji-hand/latest/release-notes.mdx
          git add content/docs/en/wuji-hand/latest/release-notes.mdx
          if git diff --cached --quiet; then
            echo "::error::æ²¡æœ‰æ–‡ä»¶å˜æ›´ï¼Œå¯èƒ½è¯¥æ—¥æœŸçš„ release notes å·²å­˜åœ¨"
            exit 1
          fi
          git commit -m "docs: update release notes for ${{ env.display_date }}"
          git push origin "${{ env.branch_name }}"
          echo "âœ… å·²æ¨é€åˆ†æ”¯: ${{ env.branch_name }}"

      - name: Create Pull Request
        if: ${{ !inputs.dry_run }}
        id: create-pr
        working-directory: docs-repo
        env:
          GH_TOKEN: ${{ steps.app-token-docs.outputs.token }}
          DISPLAY_DATE: ${{ env.display_date }}
        run: |
          REPO_LIST=$(cat ../changelogs.json | jq -r '.[] | "- \(.display_name_zh) v\(.version)"')

          cat > /tmp/pr-body.md <<BODY_EOF
          ## Summary

          - Auto-collected changelogs for release ${DISPLAY_DATE}
          - Version table and CHANGELOG content generated
          - **è¯·åœ¨ release-notes.mdx ä¸­ç²¾ç®€"ä¸»è¦æ›´æ–°"éƒ¨åˆ†**

          ### æ¶‰åŠç»„ä»¶

          ${REPO_LIST}

          ## Checklist

          - [ ] ç²¾ç®€ä¸­æ–‡ Release Notesï¼ˆåˆ é™¤å†—ä½™å†…å®¹ã€åˆå¹¶ç›¸ä¼¼é¡¹ï¼‰
          - [ ] ç¿»è¯‘å¹¶å¡«å†™è‹±æ–‡ Release Notes
          - [ ] Preview éƒ¨ç½²æ•ˆæœç¡®è®¤

          ---

          ğŸ¤– Generated by [Collect Changelogs Automation](https://github.com/wuji-technology/.github)
          BODY_EOF

          pr_url=$(gh pr create \
            --title "docs: release notes ${{ env.display_date }}" \
            --body-file /tmp/pr-body.md \
            --base main \
            --head "${{ env.branch_name }}")

          echo "âœ… PR åˆ›å»ºæˆåŠŸ: $pr_url"
          echo "pr_url=$pr_url" >> $GITHUB_OUTPUT

      - name: Send Feishu notification
        if: ${{ !inputs.dry_run && always() && steps.create-pr.outcome != 'skipped' }}
        env:
          WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          PR_URL: ${{ steps.create-pr.outputs.pr_url }}
          DISPLAY_DATE: ${{ env.display_date }}
          JOB_STATUS: ${{ job.status }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          if [ "$JOB_STATUS" = "success" ]; then
            TEMPLATE="green"
            TITLE="ğŸ“ Release Notes PR å·²åˆ›å»º"
            STATUS="âœ… æˆåŠŸ"
          else
            TEMPLATE="red"
            TITLE="âŒ Release Notes ç”Ÿæˆå¤±è´¥"
            STATUS="âŒ å¤±è´¥"
          fi

          REPO_LIST=$(cat changelogs.json 2>/dev/null | jq -r '.[] | "â€¢ \(.display_name_zh) v\(.version)"' 2>/dev/null || echo "â€¢ è§£æå¤±è´¥")

          JSON_PAYLOAD=$(jq -n \
            --arg title "$TITLE" \
            --arg template "$TEMPLATE" \
            --arg date_info "**å‘å¸ƒæ—¥æœŸ**: ${DISPLAY_DATE}" \
            --arg status "**çŠ¶æ€**: ${STATUS}" \
            --arg repos "**æ¶‰åŠç»„ä»¶**:\n${REPO_LIST}" \
            --arg reminder "âš ï¸ è¯·ç²¾ç®€ CHANGELOG åŸæ–‡ååˆå¹¶ PR" \
            --arg pr_url "${PR_URL:-$RUN_URL}" \
            '{
              msg_type: "interactive",
              card: {
                header: {
                  title: { content: $title, tag: "plain_text" },
                  template: $template
                },
                elements: [
                  { tag: "div", text: { tag: "lark_md", content: ($date_info + "\n" + $status) } },
                  { tag: "hr" },
                  { tag: "div", text: { tag: "lark_md", content: $repos } },
                  { tag: "div", text: { tag: "lark_md", content: $reminder } },
                  { tag: "action", actions: [{ tag: "button", text: { tag: "plain_text", content: "æŸ¥çœ‹ PR" }, type: "primary", url: $pr_url }] },
                  { tag: "note", elements: [{ tag: "plain_text", content: "ğŸ¤– Release Notes Automation" }] }
                ]
              }
            }')

          curl -sS --fail -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" > /dev/null

          echo "âœ… é£ä¹¦é€šçŸ¥å·²å‘é€"
